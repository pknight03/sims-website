<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="The website for Surge Information Management Support (SIMS).">

    <title>SIMS</title>


    <link href="/assets/styles/vendor.min.css" rel="stylesheet">
    <link href="/assets/styles/custom.css" rel="stylesheet">
    
    

</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
              <a id="menu-toggle-sidebar" href="#" class="btn btn-secondary"><i class="fa fa-times"></i></a>
                <li class="sidebar-brand">
                    <a href="/">SIMS</a>
                </li>
                <li>
                    <a href="/resources">Resources</a>
                </li>
                <li>
                    <a href="/toolkit">Toolkit</a>
                </li>
                <li>
                    <a href="/dashboard">Dashboard</a>
                </li>
                <li>
                    <a href="/network">Network</a>
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <!--  keep all page content within the #page-content-wrapper -->
        <div id="page-content-wrapper"> 
            
              <a href="#menu-toggle" class="btn btn-secondary" id="menu-toggle"><i class="fa fa-bars"></i></a>
              
              <!-- Dashboard  -->

<section id="dashboard">
<div class="container">
  
  <div class="row justify-content-center">
    <div class="col-10 text-center">
      <h2>SIMS Activations</h2>
    </div>
  </div>
  
  <div class="row justify-content-center d-none d-md-inline-block">
    <div class="col-10">
      <div id="map">
        <button id="reset-map" class="btn btn-md reset" style="display: none;">Reset map and table filters</button>
        <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>    
      </div>
    </div>
  </div>
  
  <br>
    
  <div class="row justify-content-center">
    <div class="col-10 col-md-6 text-center">
      <p class="d-sm-inline-block d-md-none">Information Management has been part of disaster response operations (deployed and remote) since 2011. An interactive map of all activations is available when viewing the website on a larger screen. You can download a list summary of all activations below.</p>
      <p class="d-sm-none d-md-inline-block">Information Management has been part of disaster response operations (deployed and remote) since 2011. You can download a list summary of all activations below.</p>
      <a id="download-data" class="btn btn-dark" href="https://docs.google.com/spreadsheets/d/1u2ZH4VBOjH-Rk3p4g8yel1TsBvBuyzUfwAr9le36V_A/pub?output=csv">
        <i class="fa fa-download" aria-hidden="true"></i>&nbsp; Download csv
      </a>
    </div>
  </div>

  <br>
    
    <div class="row justify-content-center">
      <div class="col-10 d-none d-md-inline-block">
        <div id="table" class="table table-hover"></div>
      </div>
    </div>
  
</div>
</section>

<!-- Footer/Feedback -->
<footer id="feedback" class="">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-10 text-center">
        <h2>Feedback</h2>
        <p>We are always looking to improve this site, content, and features. Suggestions are welcome and shall inform the periodic update of the site and tools. For technical issues with the website please send an <a href="mailto:daniel.joseph@redcross.org">email</a>.</p>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-10 text-center">
        <p class="text-muted">CC-BY</p>
      </div>
    </div>
  </div>
</footer>

<!-- Bootstrap core JavaScript -->
<script src="/assets/scripts/jquery.min.js"></script>
<script src="/assets/scripts/bootstrap.bundle.min.js"></script>

<!-- Menu Toggle Script -->
<script>
$("#menu-toggle").click(function(e) {
    e.preventDefault();
    $("#wrapper").toggleClass("toggled");
});
$("#menu-toggle-sidebar").click(function(e) {
    e.preventDefault();
    $("#wrapper").toggleClass("toggled");
});

// Scrolls to the selected menu item on the page
$(function () {
    $('a[href*=\\#]:not([href=\\#])').click(function () {
        if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') || location.hostname == this.hostname) {

            var target = $(this.hash);
            target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
            if (target.length) {
                $('html,body').animate({
                    scrollTop: target.offset().top
                }, 1000);
                return false;
            }
        }
    });
});
</script>

<script src="/assets/scripts/d3.min.js"></script>
<script src="/assets/scripts/crossfilter.js"></script>
<script src="/assets/scripts/dc.min.js"></script>
<script src="/assets/scripts/tabletop.min.js"></script>

<script>
var googleUrl = 'https://docs.google.com/spreadsheets/d/1u2ZH4VBOjH-Rk3p4g8yel1TsBvBuyzUfwAr9le36V_A/pubhtml';
var csvLocation = "https://docs.google.com/spreadsheets/d/1u2ZH4VBOjH-Rk3p4g8yel1TsBvBuyzUfwAr9le36V_A/pub?output=csv";
var jsonLocation = "/assets/data/world-map.json";
var rawData; // a global

function init() {
    Tabletop.init({
        key: googleUrl,
        callback: function (mydata, tabletop) {
            rawData = mydata;

            // cleaning data

            rawData.forEach(function (a) {
                a.Year = +a.Year;
            });

            var data = crossfilter(rawData);
            var countryDim = data.dimension(function (a) { return a.Country });
            var countryGroup = countryDim.group().reduceCount();

            var maxValue = countryGroup.top(1)[0].value + 1;
            var minValue = 1;

            // create color palette function for map colours

            var paletteScale = d3.scale.linear()
                    .domain([minValue, maxValue])
                    .range(["#ff4d4d", "#000000"]); // blue colour

            var width = document.getElementById("table").offsetWidth;

            //-------------------------------------- Map -------------------------------

            d3.json(jsonLocation, function (jsonErr, mapData) {
              
                var centre = d3.geo.centroid(mapData);
                var projection = d3.geo.mercator().center(centre).scale(140).translate([500, 220]);

                try {

                    var worldMap = dc.geoChoroplethChart("#map")
                        .width(900)
                        .height(500)
                        .dimension(countryDim)
                        .projection(projection)
                        .group(countryGroup)
                        .colors(paletteScale)
                        .transitionDelay([1500])
                        .colorCalculator(function (a) { return a ? worldMap.colors()(a) : "#d9d9d9" })
                        .overlayGeoJson(mapData.features, "state", function (a) {return a.properties.NAME;})
                } catch (e) { console.log("Error creating the map: ", e.message); }
                dc.renderAll();
                
                //clearing filters

                // var resetButton = document.getElementById("reset-map");
                // resetButton.onclick = function redraw() { worldMap.filterAll(); dc.redrawAll(); };

            }); // end of d3.json import


            //-------------------------------------- Table -----------------------------------------------------------

            try {
                var dataTable = dc.dataTable("#table")
                .width(1700)
                .height(400)
                .dimension(countryDim)
                .showGroups(false)
                .size(100) //change me if there are more than 100 lines in the table!!
                .group(function (a) {
                    return a;
                })
                .columns(["Year", "Response", "Country", "Support", "Start Date", "End Date"])
                .sortBy(function (a) { return [a["Year"], a["Response"]].join(); })
                // Need to sort create an if function to sort by start date, then if one does not exist, to sort by year
                .order(d3.descending)
                .transitionDelay([1000]);
            } catch (e) { console.log("Error creating the table: ", e.message) }

            dc.renderAll();

            //--------------------------------- map loading management (to improve UX)----------------------

            // document.onreadystatechange = function () {
            //   console.log("state: ")
            //   console.log(document.readyState)
            //     var state = document.readyState
            //     if (state == 'interactive') {
            //         document.getElementById('map').style.visibility = "hidden";
            //     } else if (state == 'complete') {
            //         setTimeout(function () {
            //             //document.getElementById('interactive');
            //             //document.getElementById('loading').style.display = "none";
            //             document.getElementById('map').style.visibility = "visible";
            //         }, 1000);
            //     }
            // };

        },
        simpleSheet: true
    })
}
window.addEventListener('DOMContentLoaded', init)

</script>

              

        </div> <!-- /#page-content-wrapper -->

    </div> <!-- /#wrapper -->

    
    


</body>

</html>